<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者設定</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="loginOverlay" class="admin-login-wrapper">
        <div class="login-box">
            <div class="logo-icon" style="margin:0 auto 20px auto; width:60px; height:60px; font-size:30px;">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h3>管理者認証</h3>
            <div class="form-group" style="text-align:left; margin-bottom:20px;">
                <input type="password" id="adminPass" class="form-control" placeholder="パスワード (1234)">
            </div>
            <button class="btn-primary" onclick="checkLogin()">ログイン</button>
            <a href="index.html" class="btn-secondary">ホームに戻る</a>
        </div>
    </div>

    <div id="adminPanel" class="container" style="display:none;">
        <header class="header">
            <a href="index.html" class="nav-btn"><i class="fas fa-arrow-left"></i> 生徒画面へ戻る</a>
            <h2>管理者設定</h2>
            <button class="nav-btn" onclick="location.reload()">ログアウト</button>
        </header>

        <div class="card" style="margin-bottom:20px; border:2px solid var(--primary);">
            <div style="display:flex; justify-content:space-between; cursor:pointer;" onclick="document.getElementById('ghSettings').style.display = document.getElementById('ghSettings').style.display==='none'?'block':'none'">
                <strong><i class="fab fa-github"></i> データ保存用設定 (GitHub Token)</strong>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="ghSettings" style="display:none; margin-top:15px;">
                <p style="font-size:12px; color:var(--text-sub)">一度保存すると次回から自動入力されます。</p>
                <div class="row"><input type="password" id="ghToken" class="form-control" placeholder="GitHub Token (repo scope)"></div>
                <div class="row">
                    <input type="text" id="ghUser" class="form-control" placeholder="Username">
                    <input type="text" id="ghRepo" class="form-control" placeholder="Repository Name">
                </div>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('time')">① 時限設定</button>
            <button class="tab-btn" onclick="switchTab('schedule')">② 時間割</button>
            <button class="tab-btn" onclick="switchTab('test')">③ テスト設定</button>
        </div>

        <div id="tab-time" class="tab-content active">
            <div class="card">
                <h3>時限設定</h3>
                <div id="timeSettingsContainer"></div>
            </div>
        </div>

        <div id="tab-schedule" class="tab-content">
            <div class="card">
                <div class="row">
                    <select id="adminClassSelect" class="form-control" onchange="renderAdminSchedule()">
                        <option value="21HR">21HR</option>
                        <option value="22HR">22HR</option>
                        <option value="23HR">23HR</option>
                        <option value="24HR">24HR</option>
                        <option value="25HR">25HR</option>
                        <option value="26HR">26HR</option>
                        <option value="27HR">27HR</option>
                        <option value="28HR">28HR</option>
                    </select>
                    <select id="adminDaySelect" class="form-control" onchange="renderAdminSchedule()">
                        <option value="Mon">月曜日</option>
                        <option value="Tue">火曜日</option>
                        <option value="Wed">水曜日</option>
                        <option value="Thu">木曜日</option>
                        <option value="Fri">金曜日</option>
                    </select>
                </div>
                <div id="scheduleInputs"></div>
            </div>
        </div>

        <div id="tab-test" class="tab-content">
            <div class="card">
                <h3>テスト追加</h3>
                <div class="row">
                    <input type="text" id="newTestName" class="form-control" placeholder="テスト名">
                    <input type="date" id="newTestDate" class="form-control">
                </div>
                <button class="btn-primary" onclick="addTest()">追加</button>
                <hr>
                <div id="testList"></div>
            </div>
        </div>

        <button class="btn-primary" style="margin-top:20px; background:#2B3674;" onclick="saveToGitHub()"><i class="fas fa-save"></i> GitHubに保存して公開</button>
    </div>

    <script src="script.js"></script>
    <script>
        let globalData = null;
        document.addEventListener('DOMContentLoaded', async () => {
            // 4. GitHub設定の自動読み込み
            if(localStorage.getItem('gh_token')) document.getElementById('ghToken').value = localStorage.getItem('gh_token');
            if(localStorage.getItem('gh_user')) document.getElementById('ghUser').value = localStorage.getItem('gh_user');
            if(localStorage.getItem('gh_repo')) document.getElementById('ghRepo').value = localStorage.getItem('gh_repo');

            globalData = await loadGlobalData();
            // データ構造の補完
            const classes = ['21HR','22HR','23HR','24HR','25HR','26HR','27HR','28HR'];
            const days = ['Mon','Tue','Wed','Thu','Fri'];
            if(!globalData.schedules) globalData.schedules = {};
            classes.forEach(c => {
                if(!globalData.schedules[c]) globalData.schedules[c] = {};
                days.forEach(d => {
                    if(!globalData.schedules[c][d]) globalData.schedules[c][d] = Array(7).fill("");
                });
            });
            renderTimeSettings(); renderAdminSchedule(); renderTestList();
        });

        function checkLogin() {
            if(document.getElementById('adminPass').value === '1234') {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
            } else alert('パスワードエラー');
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.target.classList.add('active');
        }
        function renderTimeSettings() {
            document.getElementById('timeSettingsContainer').innerHTML = globalData.timeSettings.map((t,i) => `
                <div class="row"><span style="width:30px">${t.period}</span><input type="time" value="${t.start}" onchange="globalData.timeSettings[${i}].start=this.value" class="form-control"> 〜 <input type="time" value="${t.end}" onchange="globalData.timeSettings[${i}].end=this.value" class="form-control"></div>
            `).join('');
        }
        function renderAdminSchedule() {
            const c = document.getElementById('adminClassSelect').value;
            const d = document.getElementById('adminDaySelect').value;
            if(!globalData.schedules[c]) globalData.schedules[c] = {};
            if(!globalData.schedules[c][d]) globalData.schedules[c][d] = Array(7).fill("");
            const s = globalData.schedules[c][d];
            document.getElementById('scheduleInputs').innerHTML = s.map((sub,i) => `
                <div class="row"><span>${i+1}限</span><input type="text" value="${sub}" class="form-control" onchange="globalData.schedules['${c}']['${d}'][${i}]=this.value"></div>
            `).join('');
        }
        function renderTestList() {
            document.getElementById('testList').innerHTML = globalData.tests.map((t,i) => `
                <div class="row" style="padding:10px; background:#f9f9f9;">${t.name} (${t.date}) <button onclick="globalData.tests.splice(${i},1);renderTestList()" style="margin-left:auto;color:red;border:none;">削除</button></div>
            `).join('');
        }
        function addTest() {
            const n = document.getElementById('newTestName').value;
            const d = document.getElementById('newTestDate').value;
            if(n&&d) { globalData.tests.push({name:n, date:d}); renderTestList(); }
        }
        async function saveToGitHub() {
            const t = document.getElementById('ghToken').value;
            const u = document.getElementById('ghUser').value;
            const r = document.getElementById('ghRepo').value;
            if(!t||!u||!r) return alert('GitHub設定を入力してください');
            
            // 4. GitHub設定を保存（成功前に保存）
            localStorage.setItem('gh_token', t);
            localStorage.setItem('gh_user', u);
            localStorage.setItem('gh_repo', r);

            try {
                const get = await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`, {headers:{'Authorization':`token ${t}`}});
                const sha = (await get.json()).sha;
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(globalData,null,2))));
                const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`, {
                    method:'PUT', headers:{'Authorization':`token ${t}`,'Content-Type':'application/json'},
                    body: JSON.stringify({message:"Update", content, sha})
                });
                if(res.ok) alert('保存完了'); else alert('エラー: '+ (await res.json()).message);
            } catch(e) { alert('通信エラー'); }
        }
    </script>
</body>
</html>
